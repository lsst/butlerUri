Reorganize test code to enhance code reuse and allow new schemes to make use of existing tests.
